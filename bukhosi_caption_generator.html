<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bukhosi Caption Generator | Thandiwe's Voice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #4a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            font-family: 'Georgia', serif;
        }

        .tagline {
            color: #ccc;
            font-size: 1.1em;
            font-style: italic;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-zone {
            border: 3px dashed rgba(255, 215, 0, 0.5);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-zone:hover {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .upload-zone.dragover {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.02);
        }

        #imagePreview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #captionOutput {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            margin-bottom: 15px;
            font-size: 1.05em;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .caption-actions {
            display: flex;
            gap: 10px;
        }

        .caption-actions button {
            flex: 1;
        }

        #imageAnalysis {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #ccc;
        }

        .api-config {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            color: #ffffff;
            font-size: 1em;
            margin-top: 8px;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #FFD700;
            font-weight: 600;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid #FFD700;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .history-item img {
            max-width: 100px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .history-item .caption-text {
            font-size: 0.95em;
            line-height: 1.5;
            color: #ddd;
            margin: 10px 0;
        }

        .history-item .timestamp {
            font-size: 0.85em;
            color: #999;
        }

        .icon {
            font-size: 1.2em;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">BUKHOSI</div>
            <div class="tagline">Instagram Caption Generator ‚Ä¢ Thandiwe's Voice</div>
            <div style="margin-top: 15px;">
                <a href="personality_trainer.html" style="color: #FFD700; text-decoration: none; font-size: 0.9em; border: 1px solid #FFD700; padding: 8px 15px; border-radius: 5px; display: inline-block;">
                    üß† Train Your Voice
                </a>
            </div>
        </header>

        <div class="main-grid">
            <!-- Left Column: Image Upload -->
            <div class="card">
                <h2><span class="icon">üì∏</span> Upload Image</h2>
                
                <div class="upload-zone" id="uploadZone">
                    <div>
                        <span style="font-size: 3em;">üç∑</span>
                        <p style="margin-top: 15px; font-size: 1.1em;">Drop your image here</p>
                        <p style="color: #999; margin-top: 5px;">or click to browse</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>

                <img id="imagePreview" alt="Preview">

                <div id="imageAnalysis"></div>

                <!-- Caption Length Selector -->
                <div style="margin: 20px 0; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                    <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 10px;">Caption Length:</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="length-btn active" data-length="short" style="flex: 1; padding: 10px; background: rgba(255, 215, 0, 0.2); border: 2px solid #FFD700; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
                            Short
                        </button>
                        <button class="length-btn" data-length="medium" style="flex: 1; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 6px; color: #ccc; cursor: pointer;">
                            Medium
                        </button>
                        <button class="length-btn" data-length="long" style="flex: 1; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 6px; color: #ccc; cursor: pointer;">
                            Long
                        </button>
                    </div>
                </div>

                <button id="generateBtn" disabled>
                    <span class="icon">‚ú®</span> Generate Caption
                </button>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analyzing image and generating caption...</p>
                </div>

                <div class="success-message" id="successMessage">
                    ‚úÖ Caption generated successfully!
                </div>

                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- Right Column: Caption Output -->
            <div class="card">
                <h2><span class="icon">‚úçÔ∏è</span> Generated Caption</h2>
                
                <div id="captionOutput">
                    Your AI-generated caption will appear here...
                    
                    <br><br>
                    <small style="color: #999;">Using Thandiwe's authentic voice + Bukhosi brand guidelines</small>
                </div>

                <div class="caption-actions">
                    <button id="copyBtn" disabled>
                        <span class="icon">üìã</span> Copy Caption
                    </button>
                    <button id="editBtn" disabled>
                        <span class="icon">‚úèÔ∏è</span> Edit
                    </button>
                </div>

                <button id="postBtn" disabled style="margin-top: 10px;">
                    <span class="icon">üì±</span> Post to Instagram (Coming Soon)
                </button>
            </div>
        </div>

        <!-- API Configuration -->
        <div class="card">
            <h2><span class="icon">‚öôÔ∏è</span> API Configuration</h2>
            
            <div class="api-config">
                <label for="geminiKey">Google Gemini API Key (Optional):</label>
                <input type="password" id="geminiKey" placeholder="Leave blank to use default key, or enter your own">
                <small style="color: #999; display: block; margin-top: 5px;">
                    <strong>Default:</strong> Using built-in API key (for testing)<br>
                    <strong>Custom:</strong> Get your key from: <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #FFD700;">Google AI Studio</a>
                </small>
            </div>

            <button id="saveConfigBtn">
                <span class="icon">üíæ</span> Save Configuration
            </button>
        </div>

        <!-- Caption History -->
        <div class="card">
            <h2><span class="icon">üìú</span> Caption History</h2>
            <div id="captionHistory">
                <p style="color: #999; text-align: center; padding: 20px;">No captions generated yet.</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentImage = null;
        let currentImageData = null;
        let currentCaption = '';
        let apiKey = localStorage.getItem('geminiApiKey') || '';
        let captionHistory = JSON.parse(localStorage.getItem('captionHistory') || '[]');
        let captionLength = localStorage.getItem('captionLength') || 'short'; // short, medium, long

        // Load saved API key
        if (apiKey) {
            document.getElementById('geminiKey').value = apiKey;
        }

        // Display caption history
        function displayHistory() {
            const historyContainer = document.getElementById('captionHistory');
            if (captionHistory.length === 0) {
                historyContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No captions generated yet.</p>';
                return;
            }

            historyContainer.innerHTML = captionHistory.map((item, index) => `
                <div class="history-item">
                    ${item.thumbnail ? `<img src="${item.thumbnail}" alt="Post image">` : ''}
                    <div class="caption-text">${item.caption}</div>
                    <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                </div>
            `).reverse().join('');
        }

        displayHistory();

        // Caption length selector
        const lengthButtons = document.querySelectorAll('.length-btn');
        lengthButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                lengthButtons.forEach(b => {
                    b.classList.remove('active');
                    b.style.background = 'rgba(255, 255, 255, 0.1)';
                    b.style.borderColor = 'rgba(255, 215, 0, 0.3)';
                    b.style.color = '#ccc';
                    b.style.fontWeight = 'normal';
                });
                btn.classList.add('active');
                btn.style.background = 'rgba(255, 215, 0, 0.2)';
                btn.style.borderColor = '#FFD700';
                btn.style.color = 'white';
                btn.style.fontWeight = '600';
                captionLength = btn.dataset.length;
                localStorage.setItem('captionLength', captionLength);
            });
        });
        
        // Set initial active state
        document.querySelector(`.length-btn[data-length="${captionLength}"]`)?.click();

        // Upload zone interaction
        const uploadZone = document.getElementById('uploadZone');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const generateBtn = document.getElementById('generateBtn');

        uploadZone.addEventListener('click', () => imageInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImage(file);
            }
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImage(file);
            }
        });

        function handleImage(file) {
            currentImage = file;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                currentImageData = e.target.result;
                imagePreview.src = currentImageData;
                imagePreview.style.display = 'block';
                generateBtn.disabled = !apiKey;
                
                document.getElementById('imageAnalysis').textContent = 
                    `üìä Image loaded: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            };
            
            reader.readAsDataURL(file);
        }

        // Save API configuration
        document.getElementById('saveConfigBtn').addEventListener('click', () => {
            const userKey = document.getElementById('geminiKey').value.trim();
            if (userKey) {
                apiKey = userKey;
                localStorage.setItem('geminiApiKey', apiKey);
                showSuccess('Custom API key saved! Will use your key instead of default.');
            } else {
                apiKey = '';
                localStorage.removeItem('geminiApiKey');
                showSuccess('Using default API key (built-in).');
            }
            if (currentImage) {
                generateBtn.disabled = false;
            }
        });

        // Generate caption
        document.getElementById('generateBtn').addEventListener('click', async () => {
            if (!currentImage) {
                showError('Please upload an image first');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            generateBtn.disabled = true;

            try {
                const caption = await generateCaption(currentImageData);
                currentCaption = caption;
                document.getElementById('captionOutput').textContent = caption;
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('editBtn').disabled = false;
                showSuccess('Caption generated!');
                
                // Add to history
                captionHistory.push({
                    caption: caption,
                    thumbnail: currentImageData,
                    timestamp: Date.now()
                });
                
                // Keep only last 10
                if (captionHistory.length > 10) {
                    captionHistory = captionHistory.slice(-10);
                }
                
                localStorage.setItem('captionHistory', JSON.stringify(captionHistory));
                displayHistory();
                
            } catch (error) {
                showError('Error generating caption: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                generateBtn.disabled = false;
            }
        });

        // Load personality profile from localStorage
        function loadPersonalityProfile() {
            try {
                const profile = localStorage.getItem('thandiwe_personality_profile');
                return profile ? JSON.parse(profile) : null;
            } catch (e) {
                return null;
            }
        }

        // Generate personality-enhanced prompt
        function enhancePromptWithProfile(basePrompt, profile) {
            if (!profile) return basePrompt;
            
            // Extract wine description answers
            const wineAnswers = profile.questions
                .filter(q => q.category === 'Wine Descriptions & Tasting' && q.answer)
                .map(q => q.answer)
                .join(' ');
            
            // Extract key phrases from analysis
            const keyPhrases = profile.analysis?.keyPhrases || [];
            
            // Build enhancement
            let enhancement = '';
            
            if (wineAnswers) {
                enhancement += `\n\nWINE DESCRIPTION STYLE (based on Thandiwe's expert palate):\n${wineAnswers.substring(0, 500)}\n\nWhen describing wine, use Thandiwe's authentic vocabulary and descriptions from above.`;
            }
            
            if (keyPhrases.length > 0) {
                enhancement += `\n\nKEY PHRASES TO USE: ${keyPhrases.slice(0, 5).join(', ')}`;
            }
            
            return basePrompt + enhancement;
        }

        // Generate caption using Gemini API
        async function generateCaption(imageData) {
            // Remove data URL prefix to get base64
            const base64Image = imageData.split(',')[1];
            
            // Load personality profile
            const profile = loadPersonalityProfile();
            
            // Determine length requirements based on selection
            let lengthInstruction = '';
            if (captionLength === 'short') {
                lengthInstruction = 'SHORT (80-150 characters): Concise and punchy. Get to the point quickly.';
            } else if (captionLength === 'medium') {
                lengthInstruction = 'MEDIUM (150-300 characters): Balanced storytelling with context.';
            } else {
                lengthInstruction = 'LONG (300-600 characters): Full storytelling mode. Include details, context, and connection to heritage.';
            }
            
            let prompt = `You are Thandiwe Ngubane-Zulu, co-owner of Bukhosi Royal Wines.

BRAND IDENTITY:
- South Africa's ONLY black-owned vineyard in Cape Winelands
- Founded 2008 by H.R.H. Princess Ntombifuthi Zulu (your mother) & you
- "Bukhosi" means "royalty" in isiZulu
- Tagline: "Heritage in Every Pour"
- Awards: Gold & Double Gold by Gilbert & Gaillard
- Old Vine Project certified (1976 & 1983 vintage bush vines)

YOUR VOICE:
- Warm, welcoming, PROUD (not arrogant)
- Family-oriented ("we" language - mother-daughter business)
- Educational but approachable
- Premium without pretension
- Culturally rich (embrace Zulu heritage naturally)

CAPTION STRUCTURE:
1. HOOK (1-2 compelling lines that grab attention)
2. CONTEXT (what's happening in the image)
3. CONNECTION (link to heritage/values/mission)
4. CTA (optional, natural invitation)

CRITICAL - NEVER USE THESE AI-SOUNDING PHRASES:
- "It's not just..." / "This isn't just..."
- "It's more than..." / "This is more than..."
- "Beyond just..." / "More than just..."
- "Not only... but also..."
- Any variation of these clich√©d patterns
Write naturally and directly. Be specific. Avoid meta-commentary about what things "are" or "aren't".

LENGTH REQUIREMENTS:
${lengthInstruction}
Write naturally - no artificial limits, but aim for the range above.

EMOJIS: Sparingly (max 2-3): üç∑ üëë üèÜ üåç ‚ú® üçá

HASHTAGS: 5-8 maximum
Branded: #BukhosiRoyalWines #HeritageInEveryPour
Wine: #SouthAfricanWine #CapeWinelands #Pinotage #CheninBlanc
Cultural: #ZuluHeritage #BlackOwnedBusiness #AfricanExcellence
Occasion: #WineLovers #WineTasting #Celebration

KEY FACTS (weave in when relevant):
- Only black-owned Cape Winelands vineyard
- 15+ years winemaking heritage
- Three ranges: Bukhosi (premium), Zulu Contessa (ultra-premium), LeSizwe (accessible)
- Thandiwesizwe's world-famous pasta (signature experience)
- Wine tastings: R195-R295
- Location: Cape Winelands, South Africa

CONTENT THEMES:
- Heritage & History (royal family, 15 years, old vines)
- Awards & Recognition (Gilbert & Gaillard, international praise)
- Winemaking Process (harvest, cellar, craftsmanship)
- Wine Portfolio (specific wines, tasting notes, pairings)
- Experiences (tastings, pasta, tours)
- Lifestyle & Celebration (people enjoying wine)
- Behind the Scenes (team, vineyard life, family)

ANALYZE THE IMAGE AND WRITE AN AUTHENTIC INSTAGRAM CAPTION IN YOUR VOICE.`;
            
            // Enhance prompt with personality profile if available
            prompt = enhancePromptWithProfile(prompt, profile);

            // If user has provided their own API key, use it directly
            if (apiKey) {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: "image/jpeg",
                                        data: base64Image
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 4096,
                        }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } else {
                // Use Netlify Function with env var API key
                const response = await fetch('/.netlify/functions/generate-caption', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: base64Image,
                        prompt: prompt
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API request failed');
                }

                const data = await response.json();
                return data.caption;
            }
        }

        // Copy caption
        document.getElementById('copyBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(currentCaption).then(() => {
                showSuccess('Caption copied to clipboard!');
            });
        });

        // Edit caption
        document.getElementById('editBtn').addEventListener('click', () => {
            const captionOutput = document.getElementById('captionOutput');
            const currentText = captionOutput.textContent;
            
            captionOutput.innerHTML = `<textarea style="width: 100%; min-height: 200px; background: transparent; border: 1px solid rgba(255, 215, 0, 0.3); color: white; padding: 10px; font-family: inherit; font-size: inherit; line-height: inherit; resize: vertical;">${currentText}</textarea>`;
            
            const textarea = captionOutput.querySelector('textarea');
            textarea.focus();
            
            document.getElementById('editBtn').textContent = 'üíæ Save';
            document.getElementById('editBtn').onclick = () => {
                currentCaption = textarea.value;
                captionOutput.textContent = currentCaption;
                document.getElementById('editBtn').textContent = '‚úèÔ∏è Edit';
                document.getElementById('editBtn').onclick = () => document.getElementById('editBtn').click();
                showSuccess('Caption updated!');
            };
        });

        // Helper functions
        function showSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = '‚úÖ ' + message;
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = '‚ùå ' + message;
            errorMsg.style.display = 'block';
        }
    </script>
</body>
</html>
